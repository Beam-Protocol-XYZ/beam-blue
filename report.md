# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Contract locks Ether without a withdraw function](#h-1-contract-locks-ether-without-a-withdraw-function)
  - [H-2: Reentrancy: State change after external call](#h-2-reentrancy-state-change-after-external-call)
  - [H-3: Contract Name Reused in Different Files](#h-3-contract-name-reused-in-different-files)
  - [H-4: Unsafe Casting of integers](#h-4-unsafe-casting-of-integers)
- [Low Issues](#low-issues)
  - [L-1: Centralization Risk](#l-1-centralization-risk)
  - [L-2: Costly operations inside loop](#l-2-costly-operations-inside-loop)
  - [L-3: Dead Code](#l-3-dead-code)
  - [L-4: `ecrecover` Signature Malleability](#l-4-ecrecover-signature-malleability)
  - [L-5: Empty `require()` / `revert()` Statement](#l-5-empty-require--revert-statement)
  - [L-6: Internal Function Used Only Once](#l-6-internal-function-used-only-once)
  - [L-7: Large Numeric Literal](#l-7-large-numeric-literal)
  - [L-8: Literal Instead of Constant](#l-8-literal-instead-of-constant)
  - [L-9: Local Variable Shadows State Variable](#l-9-local-variable-shadows-state-variable)
  - [L-10: Missing Inheritance](#l-10-missing-inheritance)
  - [L-11: Modifier Invoked Only Once](#l-11-modifier-invoked-only-once)
  - [L-12: `nonReentrant` is Not the First Modifier](#l-12-nonreentrant-is-not-the-first-modifier)
  - [L-13: Loop Contains `require`/`revert`](#l-13-loop-contains-requirerevert)
  - [L-14: State Change Without Event](#l-14-state-change-without-event)
  - [L-15: Address State Variable Set Without Checks](#l-15-address-state-variable-set-without-checks)
  - [L-16: State Variable Could Be Immutable](#l-16-state-variable-could-be-immutable)
  - [L-17: Unchecked Return](#l-17-unchecked-return)
  - [L-18: Uninitialized Local Variable](#l-18-uninitialized-local-variable)
  - [L-19: Unsafe ERC20 Operation](#l-19-unsafe-erc20-operation)
  - [L-20: Unspecific Solidity Pragma](#l-20-unspecific-solidity-pragma)
  - [L-21: Unused Error](#l-21-unused-error)
  - [L-22: Unused Import](#l-22-unused-import)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 43 |
| Total nSLOC | 6154 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| src/Morpho.sol | 605 |
| src/crosschain/PositionManager.sol | 825 |
| src/crosschain/RemoteExecutor.sol | 422 |
| src/crosschain/adapters/LayerZeroAdapter.sol | 159 |
| src/dex/Dex.sol | 743 |
| src/dex/RedemptionFacility.sol | 291 |
| src/dex/adapters/BackedAdapter.sol | 92 |
| src/dex/adapters/BaseRedemptionAdapter.sol | 95 |
| src/dex/adapters/CentrifugeAdapter.sol | 107 |
| src/dex/adapters/MapleAdapter.sol | 137 |
| src/dex/adapters/OndoAdapter.sol | 79 |
| src/dex/interfaces/IDex.sol | 107 |
| src/dex/interfaces/IRedemptionAdapter.sol | 25 |
| src/intent/IntentLending.sol | 414 |
| src/interfaces/CrossChainTypes.sol | 67 |
| src/interfaces/ICrossChainAdapter.sol | 15 |
| src/interfaces/IERC20.sol | 2 |
| src/interfaces/IIntentLending.sol | 149 |
| src/interfaces/IIrm.sol | 6 |
| src/interfaces/IMarginEngine.sol | 155 |
| src/interfaces/IMorpho.sol | 177 |
| src/interfaces/IMorphoCallbacks.sol | 16 |
| src/interfaces/IOracle.sol | 4 |
| src/interfaces/IStrategy.sol | 36 |
| src/libraries/ConstantsLib.sol | 8 |
| src/libraries/ErrorsLib.sol | 29 |
| src/libraries/EventsLib.sol | 49 |
| src/libraries/MarketParamsLib.sol | 10 |
| src/libraries/MathLib.sol | 25 |
| src/libraries/SafeTransferLib.sol | 31 |
| src/libraries/SharesMathLib.sol | 19 |
| src/libraries/UtilsLib.sol | 23 |
| src/libraries/periphery/MorphoBalancesLib.sol | 79 |
| src/libraries/periphery/MorphoLib.sol | 46 |
| src/libraries/periphery/MorphoStorageLib.sol | 77 |
| src/margin/ERC4626Strategy.sol | 98 |
| src/margin/MarginEngine.sol | 731 |
| src/margin/MorphoMarketStrategy.sol | 114 |
| src/mocks/ERC20Mock.sol | 33 |
| src/mocks/FlashBorrowerMock.sol | 20 |
| src/mocks/IrmMock.sol | 15 |
| src/mocks/OracleMock.sol | 8 |
| src/mocks/interfaces/IERC20.sol | 11 |
| **Total** | **6154** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 4 |
| Low | 22 |


# High Issues

## H-1: Contract locks Ether without a withdraw function

It appears that the contract includes a payable function to accept Ether but lacks a corresponding function to withdraw it, which leads to the Ether being locked in the contract. To resolve this issue, please implement a public or external function that allows for the withdrawal of Ether from the contract.

<details><summary>3 Found Instances</summary>


- Found in src/crosschain/PositionManager.sol [Line: 16](src/crosschain/PositionManager.sol#L16)

	```solidity
	contract PositionManager {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 16](src/crosschain/RemoteExecutor.sol#L16)

	```solidity
	contract RemoteExecutor {
	```

- Found in src/crosschain/adapters/LayerZeroAdapter.sol [Line: 43](src/crosschain/adapters/LayerZeroAdapter.sol#L43)

	```solidity
	contract LayerZeroAdapter is ICrossChainAdapter {
	```

</details>



## H-2: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>46 Found Instances</summary>


- Found in src/Morpho.sol [Line: 498](src/Morpho.sol#L498)

	State is changed at: `position[id][borrower].borrowShares -= repaidShares.toUint128()`, `market[id].totalBorrowShares -= repaidShares.toUint128()`, `market[id].totalBorrowAssets = UtilsLib
            .zeroFloorSub(market[id].totalBorrowAssets, repaidAssets)
            .toUint128()`, `position[id][borrower].collateral -= seizedAssets.toUint128()`, `market[id].totalBorrowAssets -= badDebtAssets.toUint128()`, `market[id].totalSupplyAssets -= badDebtAssets.toUint128()`, `market[id].totalBorrowShares -= badDebtShares.toUint128()`, `position[id][borrower].borrowShares = 0`
	```solidity
	            uint256 collateralPrice = IOracle(marketParams.oracle).price();
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 132](src/crosschain/RemoteExecutor.sol#L132)

	State is changed at: `isWhitelistedMarket[marketId] = true`, `whitelistedMarkets.push(marketId)`
	```solidity
	        MarketParams memory params = morpho.idToMarketParams(marketId);
	```

- Found in src/dex/Dex.sol [Line: 210](src/dex/Dex.sol#L210)

	State is changed at: `isWhitelistedMarket[marketId] = true`, `marketToToken[marketId] = token`, `tokenState[token].marketIds.push(marketId)`
	```solidity
	        MarketParams memory params = morpho.idToMarketParams(marketId);
	```

- Found in src/dex/RedemptionFacility.sol [Line: 144](src/dex/RedemptionFacility.sol#L144)

	State is changed at: `rwaConfigs[rwaToken] = RWAConfig({
            adapter: adapter,
            morphoMarketId: morphoMarketId,
            oracle: oracle,
            settlementPeriod: settlementPeriod,
            maxLTV: maxLTV,
            outputToken: outputToken,
            enabled: true
        })`
	```solidity
	        MarketParams memory params = morpho.idToMarketParams(morphoMarketId);
	```

- Found in src/dex/RedemptionFacility.sol [Line: 200](src/dex/RedemptionFacility.sol#L200)

	State is changed at: `redemptionId = keccak256(
            abi.encodePacked(msg.sender, rwaToken, amount, redemptionNonce++)
        )`, `redemptions[redemptionId] = ActiveRedemption({
            user: msg.sender,
            rwaToken: rwaToken,
            rwaAmount: amount,
            borrowedAmount: expectedOutput,
            borrowShares: borrowShares,
            adapterRequestId: adapterRequestId,
            timestamp: block.timestamp,
            settled: false
        })`, `totalPendingRedemptions[rwaToken] += amount`, `outState.protocolFees += protocolCut`, `outState.interestReserve += (fee - protocolCut)`
	```solidity
	        (, uint256 expectedOutput) = config.adapter.getRedemptionQuote(
	```

- Found in src/dex/RedemptionFacility.sol [Line: 226](src/dex/RedemptionFacility.sol#L226)

	State is changed at: `redemptionId = keccak256(
            abi.encodePacked(msg.sender, rwaToken, amount, redemptionNonce++)
        )`, `redemptions[redemptionId] = ActiveRedemption({
            user: msg.sender,
            rwaToken: rwaToken,
            rwaAmount: amount,
            borrowedAmount: expectedOutput,
            borrowShares: borrowShares,
            adapterRequestId: adapterRequestId,
            timestamp: block.timestamp,
            settled: false
        })`, `totalPendingRedemptions[rwaToken] += amount`, `outState.protocolFees += protocolCut`, `outState.interestReserve += (fee - protocolCut)`
	```solidity
	        bytes32 adapterRequestId = config.adapter.initiateRedemption(
	```

- Found in src/dex/RedemptionFacility.sol [Line: 280](src/dex/RedemptionFacility.sol#L280)

	State is changed at: `redemption.settled = true`, `totalPendingRedemptions[redemption.rwaToken] -= redemption.rwaAmount`, `tokenState[config.outputToken].interestReserve += surplus`
	```solidity
	        if (!config.adapter.isRedemptionComplete(redemption.adapterRequestId)) {
	```

- Found in src/dex/RedemptionFacility.sol [Line: 285](src/dex/RedemptionFacility.sol#L285)

	State is changed at: `redemption.settled = true`, `totalPendingRedemptions[redemption.rwaToken] -= redemption.rwaAmount`, `tokenState[config.outputToken].interestReserve += surplus`
	```solidity
	        uint256 redeemedAmount = config.adapter.claimRedemption(
	```

- Found in src/dex/RedemptionFacility.sol [Line: 334](src/dex/RedemptionFacility.sol#L334)

	State is changed at: `redemption.settled = true`, `totalPendingRedemptions[redemption.rwaToken] -= redemption.rwaAmount`
	```solidity
	        if (config.adapter.isRedemptionComplete(redemption.adapterRequestId)) {
	```

- Found in src/dex/RedemptionFacility.sol [Line: 335](src/dex/RedemptionFacility.sol#L335)

	State is changed at: `redemption.settled = true`, `totalPendingRedemptions[redemption.rwaToken] -= redemption.rwaAmount`
	```solidity
	            redeemedAmount = config.adapter.claimRedemption(
	```

- Found in src/dex/adapters/CentrifugeAdapter.sol [Line: 101](src/dex/adapters/CentrifugeAdapter.sol#L101)

	State is changed at: `requestId = keccak256(
            abi.encodePacked(rwaToken, msg.sender, amount, _requestNonce++)
        )`, `requests[requestId] = RedemptionRequest({
            rwaToken: rwaToken,
            owner: receiver,
            shares: amount,
            timestamp: block.timestamp
        })`, `pendingRequests[rwaToken][receiver] = requestId`
	```solidity
	        ICentrifugePool(pool).requestRedeem(amount, receiver, address(this));
	```

- Found in src/dex/adapters/CentrifugeAdapter.sol [Line: 143](src/dex/adapters/CentrifugeAdapter.sol#L143)

	State is changed at: `delete pendingRequests[req.rwaToken][req.owner]`
	```solidity
	        amount = ICentrifugePool(pool).claimRedeem(
	```

- Found in src/dex/adapters/MapleAdapter.sol [Line: 118](src/dex/adapters/MapleAdapter.sol#L118)

	State is changed at: `requestId = keccak256(
            abi.encodePacked(rwaToken, receiver, amount, _requestNonce++)
        )`, `requests[requestId] = MapleRequest({
            lpToken: rwaToken,
            pool: pool,
            shares: amount,
            receiver: receiver,
            timestamp: block.timestamp,
            claimed: false
        })`
	```solidity
	        IMaplePool(pool).requestRedeem(amount, address(this));
	```

- Found in src/dex/adapters/MapleAdapter.sol [Line: 163](src/dex/adapters/MapleAdapter.sol#L163)

	State is changed at: `req.claimed = true`
	```solidity
	                !IMapleWithdrawalManager(manager).isInExitWindow(address(this))
	```

- Found in src/dex/adapters/MapleAdapter.sol [Line: 170](src/dex/adapters/MapleAdapter.sol#L170)

	State is changed at: `req.claimed = true`
	```solidity
	        amount = IMaplePool(req.pool).redeem(
	```

- Found in src/dex/adapters/OndoAdapter.sol [Line: 91](src/dex/adapters/OndoAdapter.sol#L91)

	State is changed at: `requestAmounts[requestId] = _calculateExpectedOutput(rwaToken, amount)`
	```solidity
	        requestId = ondoRedemption.requestRedemption(rwaToken, amount);
	```

- Found in src/margin/MarginEngine.sol [Line: 165](src/margin/MarginEngine.sol#L165)

	State is changed at: `whitelistedStrategies[strategy] = whitelisted`
	```solidity
	            address asset = IStrategy(strategy).asset();
	```

- Found in src/margin/MarginEngine.sol [Line: 168](src/margin/MarginEngine.sol#L168)

	State is changed at: `whitelistedStrategies[strategy] = whitelisted`
	```solidity
	            morpho.setAuthorization(strategy, true);
	```

- Found in src/margin/MarginEngine.sol [Line: 275](src/margin/MarginEngine.sol#L275)

	State is changed at: `pos.user = msg.sender`, `pos.collateralToken = collateralToken`, `pos.loanToken = loanToken`, `pos.collateralAmount = uint128(collateralAmount)`, `pos.borrowShares = uint128(borrowShares)`, `pos.strategy = strategy`, `pos.strategyShares = uint128(strategyShares)`, `pos.lastUpdate = uint128(block.timestamp)`, `pos.active = true`, `userPositionIds[msg.sender].push(positionId)`
	```solidity
	        if (IStrategy(strategy).asset() != loanToken)
	```

- Found in src/margin/MarginEngine.sol [Line: 279](src/margin/MarginEngine.sol#L279)

	State is changed at: `pos.user = msg.sender`, `pos.collateralToken = collateralToken`, `pos.loanToken = loanToken`, `pos.collateralAmount = uint128(collateralAmount)`, `pos.borrowShares = uint128(borrowShares)`, `pos.strategy = strategy`, `pos.strategyShares = uint128(strategyShares)`, `pos.lastUpdate = uint128(block.timestamp)`, `pos.active = true`, `userPositionIds[msg.sender].push(positionId)`
	```solidity
	        uint256 collateralPrice = IOracle(pairConfig.oracle).price();
	```

- Found in src/margin/MarginEngine.sol [Line: 307](src/margin/MarginEngine.sol#L307)

	State is changed at: `pos.user = msg.sender`, `pos.collateralToken = collateralToken`, `pos.loanToken = loanToken`, `pos.collateralAmount = uint128(collateralAmount)`, `pos.borrowShares = uint128(borrowShares)`, `pos.strategy = strategy`, `pos.strategyShares = uint128(strategyShares)`, `pos.lastUpdate = uint128(block.timestamp)`, `pos.active = true`, `userPositionIds[msg.sender].push(positionId)`
	```solidity
	        MarketParams memory marketParams = morpho.idToMarketParams(
	```

- Found in src/margin/MarginEngine.sol [Line: 310](src/margin/MarginEngine.sol#L310)

	State is changed at: `pos.user = msg.sender`, `pos.collateralToken = collateralToken`, `pos.loanToken = loanToken`, `pos.collateralAmount = uint128(collateralAmount)`, `pos.borrowShares = uint128(borrowShares)`, `pos.strategy = strategy`, `pos.strategyShares = uint128(strategyShares)`, `pos.lastUpdate = uint128(block.timestamp)`, `pos.active = true`, `userPositionIds[msg.sender].push(positionId)`
	```solidity
	        (, uint256 borrowShares) = morpho.borrow(
	```

- Found in src/margin/MarginEngine.sol [Line: 319](src/margin/MarginEngine.sol#L319)

	State is changed at: `pos.user = msg.sender`, `pos.collateralToken = collateralToken`, `pos.loanToken = loanToken`, `pos.collateralAmount = uint128(collateralAmount)`, `pos.borrowShares = uint128(borrowShares)`, `pos.strategy = strategy`, `pos.strategyShares = uint128(strategyShares)`, `pos.lastUpdate = uint128(block.timestamp)`, `pos.active = true`, `userPositionIds[msg.sender].push(positionId)`
	```solidity
	        uint256 strategyShares = IStrategy(strategy).deposit(
	```

- Found in src/margin/MarginEngine.sol [Line: 424](src/margin/MarginEngine.sol#L424)

	State is changed at: `pos.borrowShares += uint128(newShares)`, `pos.strategyShares += uint128(additionalStrategyShares)`, `pos.lastUpdate = uint128(block.timestamp)`
	```solidity
	        uint256 collateralPrice = IOracle(pairConfig.oracle).price();
	```

- Found in src/margin/MarginEngine.sol [Line: 432](src/margin/MarginEngine.sol#L432)

	State is changed at: `pos.borrowShares += uint128(newShares)`, `pos.strategyShares += uint128(additionalStrategyShares)`, `pos.lastUpdate = uint128(block.timestamp)`
	```solidity
	        Market memory market = morpho.market(pairConfig.morphoMarketId);
	```

- Found in src/margin/MarginEngine.sol [Line: 443](src/margin/MarginEngine.sol#L443)

	State is changed at: `pos.borrowShares += uint128(newShares)`, `pos.strategyShares += uint128(additionalStrategyShares)`, `pos.lastUpdate = uint128(block.timestamp)`
	```solidity
	        uint256 strategyValue = IStrategy(pos.strategy).convertToAssets(
	```

- Found in src/margin/MarginEngine.sol [Line: 456](src/margin/MarginEngine.sol#L456)

	State is changed at: `pos.borrowShares += uint128(newShares)`, `pos.strategyShares += uint128(additionalStrategyShares)`, `pos.lastUpdate = uint128(block.timestamp)`
	```solidity
	        MarketParams memory marketParams = morpho.idToMarketParams(
	```

- Found in src/margin/MarginEngine.sol [Line: 459](src/margin/MarginEngine.sol#L459)

	State is changed at: `pos.borrowShares += uint128(newShares)`, `pos.strategyShares += uint128(additionalStrategyShares)`, `pos.lastUpdate = uint128(block.timestamp)`
	```solidity
	        (, uint256 newShares) = morpho.borrow(
	```

- Found in src/margin/MarginEngine.sol [Line: 468](src/margin/MarginEngine.sol#L468)

	State is changed at: `pos.borrowShares += uint128(newShares)`, `pos.strategyShares += uint128(additionalStrategyShares)`, `pos.lastUpdate = uint128(block.timestamp)`
	```solidity
	        uint256 additionalStrategyShares = IStrategy(pos.strategy).deposit(
	```

- Found in src/margin/MarginEngine.sol [Line: 497](src/margin/MarginEngine.sol#L497)

	State is changed at: `pos.borrowShares -= uint128(actualSharesRepaid)`, `pos.strategyShares -= uint128(strategySharesNeeded)`, `pos.lastUpdate = uint128(block.timestamp)`
	```solidity
	        MarketParams memory marketParams = morpho.idToMarketParams(
	```

- Found in src/margin/MarginEngine.sol [Line: 500](src/margin/MarginEngine.sol#L500)

	State is changed at: `pos.borrowShares -= uint128(actualSharesRepaid)`, `pos.strategyShares -= uint128(strategySharesNeeded)`, `pos.lastUpdate = uint128(block.timestamp)`
	```solidity
	        Market memory market = morpho.market(pairConfig.morphoMarketId);
	```

- Found in src/margin/MarginEngine.sol [Line: 516](src/margin/MarginEngine.sol#L516)

	State is changed at: `pos.borrowShares -= uint128(actualSharesRepaid)`, `pos.strategyShares -= uint128(strategySharesNeeded)`, `pos.lastUpdate = uint128(block.timestamp)`
	```solidity
	        uint256 assetsReceived = IStrategy(pos.strategy).redeem(
	```

- Found in src/margin/MarginEngine.sol [Line: 523](src/margin/MarginEngine.sol#L523)

	State is changed at: `pos.borrowShares -= uint128(actualSharesRepaid)`, `pos.strategyShares -= uint128(strategySharesNeeded)`, `pos.lastUpdate = uint128(block.timestamp)`
	```solidity
	        (uint256 assetsRepaid, uint256 actualSharesRepaid) = morpho.repay(
	```

- Found in src/margin/MarginEngine.sol [Line: 557](src/margin/MarginEngine.sol#L557)

	State is changed at: `pos.active = false`, `pos.collateralAmount = 0`, `pos.borrowShares = 0`, `pos.strategyShares = 0`
	```solidity
	        uint256 strategyAssets = IStrategy(pos.strategy).redeem(
	```

- Found in src/margin/MarginEngine.sol [Line: 564](src/margin/MarginEngine.sol#L564)

	State is changed at: `pos.active = false`, `pos.collateralAmount = 0`, `pos.borrowShares = 0`, `pos.strategyShares = 0`
	```solidity
	        MarketParams memory marketParams = morpho.idToMarketParams(
	```

- Found in src/margin/MarginEngine.sol [Line: 567](src/margin/MarginEngine.sol#L567)

	State is changed at: `pos.active = false`, `pos.collateralAmount = 0`, `pos.borrowShares = 0`, `pos.strategyShares = 0`
	```solidity
	        Market memory market = morpho.market(pairConfig.morphoMarketId);
	```

- Found in src/margin/MarginEngine.sol [Line: 578](src/margin/MarginEngine.sol#L578)

	State is changed at: `pos.active = false`, `pos.collateralAmount = 0`, `pos.borrowShares = 0`, `pos.strategyShares = 0`
	```solidity
	            morpho.repay(marketParams, assetsToRepay, 0, address(this), "");
	```

- Found in src/margin/MarginEngine.sol [Line: 593](src/margin/MarginEngine.sol#L593)

	State is changed at: `pos.active = false`, `pos.collateralAmount = 0`, `pos.borrowShares = 0`, `pos.strategyShares = 0`
	```solidity
	            uint256 collateralPrice = IOracle(pairConfig.oracle).price();
	```

- Found in src/margin/MarginEngine.sol [Line: 637](src/margin/MarginEngine.sol#L637)

	State is changed at: `pos.borrowShares -= uint128(sharesRepaid)`, `pos.strategyShares -= uint128(strategySharesNeeded)`, `pos.collateralAmount -= uint128(collateralToSeize)`, `pos.borrowShares = 0`, `pos.active = false`, `pos.active = false`
	```solidity
	        uint256 collateralPrice = IOracle(pairConfig.oracle).price();
	```

- Found in src/margin/MarginEngine.sol [Line: 642](src/margin/MarginEngine.sol#L642)

	State is changed at: `pos.borrowShares -= uint128(sharesRepaid)`, `pos.strategyShares -= uint128(strategySharesNeeded)`, `pos.collateralAmount -= uint128(collateralToSeize)`, `pos.borrowShares = 0`, `pos.active = false`, `pos.active = false`
	```solidity
	        MarketParams memory marketParams = morpho.idToMarketParams(
	```

- Found in src/margin/MarginEngine.sol [Line: 645](src/margin/MarginEngine.sol#L645)

	State is changed at: `pos.borrowShares -= uint128(sharesRepaid)`, `pos.strategyShares -= uint128(strategySharesNeeded)`, `pos.collateralAmount -= uint128(collateralToSeize)`, `pos.borrowShares = 0`, `pos.active = false`, `pos.active = false`
	```solidity
	        Market memory market = morpho.market(pairConfig.morphoMarketId);
	```

- Found in src/margin/MarginEngine.sol [Line: 659](src/margin/MarginEngine.sol#L659)

	State is changed at: `pos.borrowShares -= uint128(sharesRepaid)`, `pos.strategyShares -= uint128(strategySharesNeeded)`, `pos.collateralAmount -= uint128(collateralToSeize)`, `pos.borrowShares = 0`, `pos.active = false`, `pos.active = false`
	```solidity
	        uint256 strategyValue = IStrategy(pos.strategy).convertToAssets(
	```

- Found in src/margin/MarginEngine.sol [Line: 665](src/margin/MarginEngine.sol#L665)

	State is changed at: `pos.borrowShares -= uint128(sharesRepaid)`, `pos.strategyShares -= uint128(strategySharesNeeded)`, `pos.collateralAmount -= uint128(collateralToSeize)`, `pos.borrowShares = 0`, `pos.active = false`, `pos.active = false`
	```solidity
	            strategySharesNeeded = IStrategy(pos.strategy).previewWithdraw(
	```

- Found in src/margin/MarginEngine.sol [Line: 675](src/margin/MarginEngine.sol#L675)

	State is changed at: `pos.borrowShares -= uint128(sharesRepaid)`, `pos.strategyShares -= uint128(strategySharesNeeded)`, `pos.collateralAmount -= uint128(collateralToSeize)`, `pos.borrowShares = 0`, `pos.active = false`, `pos.active = false`
	```solidity
	        uint256 assetsFromStrategy = IStrategy(pos.strategy).redeem(
	```

- Found in src/margin/MarginEngine.sol [Line: 685](src/margin/MarginEngine.sol#L685)

	State is changed at: `pos.borrowShares -= uint128(sharesRepaid)`, `pos.strategyShares -= uint128(strategySharesNeeded)`, `pos.collateralAmount -= uint128(collateralToSeize)`, `pos.borrowShares = 0`, `pos.active = false`, `pos.active = false`
	```solidity
	        (, uint256 sharesRepaid) = morpho.repay(
	```

- Found in src/margin/MorphoMarketStrategy.sol [Line: 31](src/margin/MorphoMarketStrategy.sol#L31)

	State is changed at: `loanToken = params.loanToken`
	```solidity
	        MarketParams memory params = morpho.idToMarketParams(_marketId);
	```

</details>



## H-3: Contract Name Reused in Different Files

When compiling contracts with certain development frameworks (for example: Truffle), having contracts with the same name across different files can lead to one being overwritten.

<details><summary>2 Found Instances</summary>


- Found in src/interfaces/IERC20.sol [Line: 9](src/interfaces/IERC20.sol#L9)

	```solidity
	interface IERC20 {}
	```

- Found in src/mocks/interfaces/IERC20.sol [Line: 4](src/mocks/interfaces/IERC20.sol#L4)

	```solidity
	interface IERC20 {
	```

</details>



## H-4: Unsafe Casting of integers

Downcasting int/uints in Solidity can be unsafe due to the potential for data loss and unintended behavior.When downcasting a larger integer type to a smaller one (e.g., uint256 to uint128), the value may exceed the range of the target type,leading to truncation and loss of significant digits. Use OpenZeppelin's SafeCast library to safely downcast integers.

<details><summary>11 Found Instances</summary>


- Found in src/crosschain/PositionManager.sol [Line: 586](src/crosschain/PositionManager.sol#L586)

	```solidity
	        pos.collateralAmount -= uint128(collateralToSeize);
	```

- Found in src/crosschain/PositionManager.sol [Line: 589](src/crosschain/PositionManager.sol#L589)

	```solidity
	        pos.borrowShares -= uint128(sharesToLiquidate);
	```

- Found in src/crosschain/PositionManager.sol [Line: 901](src/crosschain/PositionManager.sol#L901)

	```solidity
	                totalBorrowAssets += uint128(interest);
	```

- Found in src/crosschain/PositionManager.sol [Line: 927](src/crosschain/PositionManager.sol#L927)

	```solidity
	                totalBorrowAssets += uint128(interest);
	```

- Found in src/margin/MarginEngine.sol [Line: 329](src/margin/MarginEngine.sol#L329)

	```solidity
	        pos.borrowShares = uint128(borrowShares);
	```

- Found in src/margin/MarginEngine.sol [Line: 331](src/margin/MarginEngine.sol#L331)

	```solidity
	        pos.strategyShares = uint128(strategyShares);
	```

- Found in src/margin/MarginEngine.sol [Line: 473](src/margin/MarginEngine.sol#L473)

	```solidity
	        pos.borrowShares += uint128(newShares);
	```

- Found in src/margin/MarginEngine.sol [Line: 474](src/margin/MarginEngine.sol#L474)

	```solidity
	        pos.strategyShares += uint128(additionalStrategyShares);
	```

- Found in src/margin/MarginEngine.sol [Line: 531](src/margin/MarginEngine.sol#L531)

	```solidity
	        pos.borrowShares -= uint128(actualSharesRepaid);
	```

- Found in src/margin/MarginEngine.sol [Line: 532](src/margin/MarginEngine.sol#L532)

	```solidity
	        pos.strategyShares -= uint128(strategySharesNeeded);
	```

- Found in src/margin/MarginEngine.sol [Line: 705](src/margin/MarginEngine.sol#L705)

	```solidity
	        pos.borrowShares -= uint128(sharesRepaid);
	```

</details>



# Low Issues

## L-1: Centralization Risk

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>52 Found Instances</summary>


- Found in src/Morpho.sol [Line: 99](src/Morpho.sol#L99)

	```solidity
	    function setOwner(address newOwner) external onlyOwner {
	```

- Found in src/Morpho.sol [Line: 108](src/Morpho.sol#L108)

	```solidity
	    function enableIrm(address irm) external onlyOwner {
	```

- Found in src/Morpho.sol [Line: 117](src/Morpho.sol#L117)

	```solidity
	    function enableLltv(uint256 lltv) external onlyOwner {
	```

- Found in src/Morpho.sol [Line: 130](src/Morpho.sol#L130)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/Morpho.sol [Line: 146](src/Morpho.sol#L146)

	```solidity
	    function setFeeRecipient(address newFeeRecipient) external onlyOwner {
	```

- Found in src/Morpho.sol [Line: 159](src/Morpho.sol#L159)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/crosschain/PositionManager.sol [Line: 219](src/crosschain/PositionManager.sol#L219)

	```solidity
	    function setAdapter(address _adapter) external onlyOwner {
	```

- Found in src/crosschain/PositionManager.sol [Line: 224](src/crosschain/PositionManager.sol#L224)

	```solidity
	    function setPaused(bool _paused) external onlyOwner {
	```

- Found in src/crosschain/PositionManager.sol [Line: 234](src/crosschain/PositionManager.sol#L234)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/crosschain/PositionManager.sol [Line: 257](src/crosschain/PositionManager.sol#L257)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/crosschain/PositionManager.sol [Line: 281](src/crosschain/PositionManager.sol#L281)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/crosschain/PositionManager.sol [Line: 680](src/crosschain/PositionManager.sol#L680)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/crosschain/PositionManager.sol [Line: 703](src/crosschain/PositionManager.sol#L703)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 118](src/crosschain/RemoteExecutor.sol#L118)

	```solidity
	    function setAdapter(address _adapter) external onlyOwner {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 123](src/crosschain/RemoteExecutor.sol#L123)

	```solidity
	    function setPaused(bool _paused) external onlyOwner {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 129](src/crosschain/RemoteExecutor.sol#L129)

	```solidity
	    function whitelistMarket(Id marketId) external onlyOwner {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 141](src/crosschain/RemoteExecutor.sol#L141)

	```solidity
	    function delistMarket(Id marketId) external onlyOwner {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 162](src/crosschain/RemoteExecutor.sol#L162)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 182](src/crosschain/RemoteExecutor.sol#L182)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 513](src/crosschain/RemoteExecutor.sol#L513)

	```solidity
	    ) external payable onlyOwner {
	```

- Found in src/crosschain/adapters/LayerZeroAdapter.sol [Line: 102](src/crosschain/adapters/LayerZeroAdapter.sol#L102)

	```solidity
	    function setTrustedRemote(uint32 eid, address remote) external onlyOwner {
	```

- Found in src/crosschain/adapters/LayerZeroAdapter.sol [Line: 110](src/crosschain/adapters/LayerZeroAdapter.sol#L110)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/crosschain/adapters/LayerZeroAdapter.sol [Line: 115](src/crosschain/adapters/LayerZeroAdapter.sol#L115)

	```solidity
	    function setReceiver(address _receiver) external onlyOwner {
	```

- Found in src/dex/Dex.sol [Line: 200](src/dex/Dex.sol#L200)

	```solidity
	    function transferOwnership(address newOwner) external onlyOwner {
	```

- Found in src/dex/Dex.sol [Line: 207](src/dex/Dex.sol#L207)

	```solidity
	    function whitelistMarket(Id marketId) external onlyOwner {
	```

- Found in src/dex/Dex.sol [Line: 225](src/dex/Dex.sol#L225)

	```solidity
	    function removeMarket(Id marketId) external onlyOwner {
	```

- Found in src/dex/Dex.sol [Line: 265](src/dex/Dex.sol#L265)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/dex/Dex.sol [Line: 277](src/dex/Dex.sol#L277)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/dex/Dex.sol [Line: 305](src/dex/Dex.sol#L305)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/dex/Dex.sol [Line: 312](src/dex/Dex.sol#L312)

	```solidity
	    function setPaused(bool _paused) external onlyOwner {
	```

- Found in src/dex/Dex.sol [Line: 321](src/dex/Dex.sol#L321)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/dex/Dex.sol [Line: 329](src/dex/Dex.sol#L329)

	```solidity
	    function delistPair(address tokenIn, address tokenOut) external onlyOwner {
	```

- Found in src/dex/Dex.sol [Line: 338](src/dex/Dex.sol#L338)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/dex/RedemptionFacility.sol [Line: 137](src/dex/RedemptionFacility.sol#L137)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/dex/RedemptionFacility.sol [Line: 170](src/dex/RedemptionFacility.sol#L170)

	```solidity
	    function disableRWA(address rwaToken) external onlyOwner {
	```

- Found in src/dex/adapters/BackedAdapter.sol [Line: 77](src/dex/adapters/BackedAdapter.sol#L77)

	```solidity
	    function setBackedRedemption(address _backedRedemption) external onlyOwner {
	```

- Found in src/dex/adapters/BaseRedemptionAdapter.sol [Line: 74](src/dex/adapters/BaseRedemptionAdapter.sol#L74)

	```solidity
	    function transferOwnership(address newOwner) external onlyOwner {
	```

- Found in src/dex/adapters/BaseRedemptionAdapter.sol [Line: 88](src/dex/adapters/BaseRedemptionAdapter.sol#L88)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/dex/adapters/BaseRedemptionAdapter.sol [Line: 101](src/dex/adapters/BaseRedemptionAdapter.sol#L101)

	```solidity
	    function removeToken(address rwaToken) external onlyOwner {
	```

- Found in src/dex/adapters/CentrifugeAdapter.sol [Line: 75](src/dex/adapters/CentrifugeAdapter.sol#L75)

	```solidity
	    function configurePool(address rwaToken, address pool) external onlyOwner {
	```

- Found in src/dex/adapters/MapleAdapter.sol [Line: 93](src/dex/adapters/MapleAdapter.sol#L93)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/dex/adapters/OndoAdapter.sol [Line: 66](src/dex/adapters/OndoAdapter.sol#L66)

	```solidity
	    function setOndoRedemption(address _ondoRedemption) external onlyOwner {
	```

- Found in src/intent/IntentLending.sol [Line: 76](src/intent/IntentLending.sol#L76)

	```solidity
	    function transferOwnership(address newOwner) external onlyOwner {
	```

- Found in src/intent/IntentLending.sol [Line: 81](src/intent/IntentLending.sol#L81)

	```solidity
	    function setPaused(bool _paused) external onlyOwner {
	```

- Found in src/intent/IntentLending.sol [Line: 90](src/intent/IntentLending.sol#L90)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/margin/MarginEngine.sol [Line: 111](src/margin/MarginEngine.sol#L111)

	```solidity
	    function transferOwnership(address newOwner) external onlyOwner {
	```

- Found in src/margin/MarginEngine.sol [Line: 130](src/margin/MarginEngine.sol#L130)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/margin/MarginEngine.sol [Line: 161](src/margin/MarginEngine.sol#L161)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/margin/MarginEngine.sol [Line: 175](src/margin/MarginEngine.sol#L175)

	```solidity
	    function setPaused(bool _paused) external onlyOwner {
	```

- Found in src/margin/MarginEngine.sol [Line: 187](src/margin/MarginEngine.sol#L187)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/margin/MarginEngine.sol [Line: 221](src/margin/MarginEngine.sol#L221)

	```solidity
	    ) external onlyOwner {
	```

- Found in src/margin/MarginEngine.sol [Line: 250](src/margin/MarginEngine.sol#L250)

	```solidity
	    ) external onlyOwner {
	```

</details>



## L-2: Costly operations inside loop

Invoking `SSTORE` operations in loops may waste gas. Use a local variable to hold the loop computation result.

<details><summary>5 Found Instances</summary>


- Found in src/crosschain/RemoteExecutor.sol [Line: 146](src/crosschain/RemoteExecutor.sol#L146)

	```solidity
	        for (uint256 i = 0; i < whitelistedMarkets.length; i++) {
	```

- Found in src/dex/Dex.sol [Line: 249](src/dex/Dex.sol#L249)

	```solidity
	        for (uint256 i = 0; i < markets.length; i++) {
	```

- Found in src/dex/Dex.sol [Line: 914](src/dex/Dex.sol#L914)

	```solidity
	        for (
	```

- Found in src/margin/MarginEngine.sol [Line: 207](src/margin/MarginEngine.sol#L207)

	```solidity
	        for (uint256 i = 0; i < loanTokens.length; i++) {
	```

- Found in src/margin/MarginEngine.sol [Line: 239](src/margin/MarginEngine.sol#L239)

	```solidity
	        for (uint256 i = 0; i < collateralTokens.length; i++) {
	```

</details>



## L-3: Dead Code

Functions that are not used. Consider removing them.

<details><summary>1 Found Instances</summary>


- Found in src/crosschain/PositionManager.sol [Line: 908](src/crosschain/PositionManager.sol#L908)

	```solidity
	    function _assetsToShares(
	```

</details>



## L-4: `ecrecover` Signature Malleability

The `ecrecover` function is susceptible to signature malleability. This means that the same message can be signed in multiple ways, allowing an attacker to change the message signature without invalidating it. This can lead to unexpected behavior in smart contracts, such as the loss of funds or the ability to bypass access control. Consider using OpenZeppelin's ECDSA library instead of the built-in function.

<details><summary>1 Found Instances</summary>


- Found in src/Morpho.sol [Line: 660](src/Morpho.sol#L660)

	```solidity
	        address signatory = ecrecover(
	```

</details>



## L-5: Empty `require()` / `revert()` Statement

Use descriptive reason strings or custom errors for revert paths.

<details><summary>1 Found Instances</summary>


- Found in src/mocks/FlashBorrowerMock.sol [Line: 22](src/mocks/FlashBorrowerMock.sol#L22)

	```solidity
	        require(msg.sender == address(MORPHO));
	```

</details>



## L-6: Internal Function Used Only Once

Instead of separating the logic into a separate function, consider inlining the logic into the calling function. This can reduce the number of function calls and improve readability.

<details><summary>1 Found Instances</summary>


- Found in src/libraries/MathLib.sol [Line: 32](src/libraries/MathLib.sol#L32)

	```solidity
	    function mulDivUp(uint256 x, uint256 y, uint256 d) internal pure returns (uint256) {
	```

</details>



## L-7: Large Numeric Literal

Large literal values multiples of 10000 can be replaced with scientific notation.Use `e` notation, for example: `1e18`, instead of its full numeric value.

<details><summary>2 Found Instances</summary>


- Found in src/crosschain/adapters/LayerZeroAdapter.sol [Line: 228](src/crosschain/adapters/LayerZeroAdapter.sol#L228)

	```solidity
	                uint256(200000) // gas limit
	```

- Found in src/dex/Dex.sol [Line: 30](src/dex/Dex.sol#L30)

	```solidity
	    uint256 public constant BPS_SCALE = 10000;
	```

</details>



## L-8: Literal Instead of Constant

Define and use `constant` variables instead of using literals. If the same constant literal value is used multiple times, create a constant state variable and reference it throughout the contract.

<details><summary>12 Found Instances</summary>


- Found in src/crosschain/PositionManager.sol [Line: 1052](src/crosschain/PositionManager.sol#L1052)

	```solidity
	            return amount / (10 ** (fromDecimals - toDecimals));
	```

- Found in src/crosschain/PositionManager.sol [Line: 1054](src/crosschain/PositionManager.sol#L1054)

	```solidity
	        return amount * (10 ** (toDecimals - fromDecimals));
	```

- Found in src/dex/Dex.sol [Line: 266](src/dex/Dex.sol#L266)

	```solidity
	        if (supply + repay + liquidity != 100) revert InvalidAllocation();
	```

- Found in src/dex/Dex.sol [Line: 370](src/dex/Dex.sol#L370)

	```solidity
	            toSupply = (amount * supplyAllocation) / 100;
	```

- Found in src/dex/Dex.sol [Line: 371](src/dex/Dex.sol#L371)

	```solidity
	            toRepay = (amount * repayAllocation) / 100;
	```

- Found in src/dex/Dex.sol [Line: 375](src/dex/Dex.sol#L375)

	```solidity
	            toSupply = (amount * 66) / 100;
	```

- Found in src/intent/IntentLending.sol [Line: 313](src/intent/IntentLending.sol#L313)

	```solidity
	        uint256 requiredCollateral = (loanAmount * 1e18) /
	```

- Found in src/intent/IntentLending.sol [Line: 503](src/intent/IntentLending.sol#L503)

	```solidity
	        health = (collateralValue * 1e18) / debt;
	```

- Found in src/libraries/periphery/MorphoLib.sol [Line: 25](src/libraries/periphery/MorphoLib.sol#L25)

	```solidity
	        return uint256(morpho.extSloads(slot)[0] >> 128);
	```

- Found in src/libraries/periphery/MorphoLib.sol [Line: 35](src/libraries/periphery/MorphoLib.sol#L35)

	```solidity
	        return uint256(morpho.extSloads(slot)[0] >> 128);
	```

- Found in src/libraries/periphery/MorphoLib.sol [Line: 45](src/libraries/periphery/MorphoLib.sol#L45)

	```solidity
	        return uint256(morpho.extSloads(slot)[0] >> 128);
	```

- Found in src/libraries/periphery/MorphoLib.sol [Line: 55](src/libraries/periphery/MorphoLib.sol#L55)

	```solidity
	        return uint256(morpho.extSloads(slot)[0] >> 128);
	```

</details>



## L-9: Local Variable Shadows State Variable

Rename the local variable that shadows another state variable.

<details><summary>1 Found Instances</summary>


- Found in src/dex/adapters/CentrifugeAdapter.sol [Line: 48](src/dex/adapters/CentrifugeAdapter.sol#L48)

	```solidity
	        address owner;
	```

</details>



## L-10: Missing Inheritance

There is an interface / abstract contract that is potentially missing (not included in) the inheritance of this contract.

<details><summary>1 Found Instances</summary>


- Found in src/dex/Dex.sol [Line: 17](src/dex/Dex.sol#L17)

	Is this contract supposed to implement an interface? Consider extending one of the following: IDex
	```solidity
	contract Dex {
	```

</details>



## L-11: Modifier Invoked Only Once

Consider removing the modifier or inlining the logic into the calling function.

<details><summary>4 Found Instances</summary>


- Found in src/crosschain/RemoteExecutor.sol [Line: 89](src/crosschain/RemoteExecutor.sol#L89)

	```solidity
	    modifier whenNotPaused() {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 94](src/crosschain/RemoteExecutor.sol#L94)

	```solidity
	    modifier nonReentrant() {
	```

- Found in src/crosschain/adapters/LayerZeroAdapter.sol [Line: 80](src/crosschain/adapters/LayerZeroAdapter.sol#L80)

	```solidity
	    modifier onlyEndpoint() {
	```

- Found in src/crosschain/adapters/LayerZeroAdapter.sol [Line: 85](src/crosschain/adapters/LayerZeroAdapter.sol#L85)

	```solidity
	    modifier onlyAuthorized() {
	```

</details>



## L-12: `nonReentrant` is Not the First Modifier

To protect against reentrancy in other modifiers, the `nonReentrant` modifier should be the first modifier in the list of modifiers.

<details><summary>12 Found Instances</summary>


- Found in src/crosschain/PositionManager.sol [Line: 295](src/crosschain/PositionManager.sol#L295)

	```solidity
	    ) external whenNotPaused nonReentrant returns (bytes32 positionId) {
	```

- Found in src/crosschain/PositionManager.sol [Line: 391](src/crosschain/PositionManager.sol#L391)

	```solidity
	    ) external payable whenNotPaused nonReentrant returns (uint64 nonce) {
	```

- Found in src/crosschain/PositionManager.sol [Line: 466](src/crosschain/PositionManager.sol#L466)

	```solidity
	    ) external payable whenNotPaused nonReentrant {
	```

- Found in src/crosschain/PositionManager.sol [Line: 520](src/crosschain/PositionManager.sol#L520)

	```solidity
	    ) external payable whenNotPaused nonReentrant {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 198](src/crosschain/RemoteExecutor.sol#L198)

	```solidity
	    ) external whenNotPaused nonReentrant {
	```

- Found in src/dex/Dex.sol [Line: 355](src/dex/Dex.sol#L355)

	```solidity
	    ) external whenNotPaused nonReentrant returns (uint256 shares) {
	```

- Found in src/dex/Dex.sol [Line: 459](src/dex/Dex.sol#L459)

	```solidity
	    ) external whenNotPaused nonReentrant returns (uint256 amountOut) {
	```

- Found in src/dex/RedemptionFacility.sol [Line: 191](src/dex/RedemptionFacility.sol#L191)

	```solidity
	        nonReentrant
	```

- Found in src/intent/IntentLending.sol [Line: 264](src/intent/IntentLending.sol#L264)

	```solidity
	    ) external whenNotPaused nonReentrant returns (bytes32 loanId) {
	```

- Found in src/margin/MarginEngine.sol [Line: 266](src/margin/MarginEngine.sol#L266)

	```solidity
	    ) external whenNotPaused nonReentrant returns (bytes32 positionId) {
	```

- Found in src/margin/MarginEngine.sol [Line: 413](src/margin/MarginEngine.sol#L413)

	```solidity
	    ) external whenNotPaused nonReentrant {
	```

- Found in src/margin/MarginEngine.sol [Line: 630](src/margin/MarginEngine.sol#L630)

	```solidity
	    ) external whenNotPaused nonReentrant {
	```

</details>



## L-13: Loop Contains `require`/`revert`

Avoid `require` / `revert` statements in a loop because a single bad item can cause the whole transaction to fail. It's better to forgive on fail and return failed elements post processing of the loop

<details><summary>2 Found Instances</summary>


- Found in src/margin/MarginEngine.sol [Line: 207](src/margin/MarginEngine.sol#L207)

	```solidity
	        for (uint256 i = 0; i < loanTokens.length; i++) {
	```

- Found in src/margin/MarginEngine.sol [Line: 239](src/margin/MarginEngine.sol#L239)

	```solidity
	        for (uint256 i = 0; i < collateralTokens.length; i++) {
	```

</details>



## L-14: State Change Without Event

There are state variable changes in this function but no event is emitted. Consider emitting an event to enable offchain indexers to track the changes.

<details><summary>20 Found Instances</summary>


- Found in src/crosschain/PositionManager.sol [Line: 219](src/crosschain/PositionManager.sol#L219)

	```solidity
	    function setAdapter(address _adapter) external onlyOwner {
	```

- Found in src/crosschain/PositionManager.sol [Line: 224](src/crosschain/PositionManager.sol#L224)

	```solidity
	    function setPaused(bool _paused) external onlyOwner {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 118](src/crosschain/RemoteExecutor.sol#L118)

	```solidity
	    function setAdapter(address _adapter) external onlyOwner {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 123](src/crosschain/RemoteExecutor.sol#L123)

	```solidity
	    function setPaused(bool _paused) external onlyOwner {
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 178](src/crosschain/RemoteExecutor.sol#L178)

	```solidity
	    function withdrawReserve(
	```

- Found in src/crosschain/adapters/LayerZeroAdapter.sol [Line: 115](src/crosschain/adapters/LayerZeroAdapter.sol#L115)

	```solidity
	    function setReceiver(address _receiver) external onlyOwner {
	```

- Found in src/dex/Dex.sol [Line: 335](src/dex/Dex.sol#L335)

	```solidity
	    function withdrawProtocolFees(
	```

- Found in src/dex/adapters/CentrifugeAdapter.sol [Line: 84](src/dex/adapters/CentrifugeAdapter.sol#L84)

	```solidity
	    function initiateRedemption(
	```

- Found in src/dex/adapters/CentrifugeAdapter.sol [Line: 133](src/dex/adapters/CentrifugeAdapter.sol#L133)

	```solidity
	    function claimRedemption(
	```

- Found in src/dex/adapters/MapleAdapter.sol [Line: 103](src/dex/adapters/MapleAdapter.sol#L103)

	```solidity
	    function initiateRedemption(
	```

- Found in src/dex/adapters/MapleAdapter.sol [Line: 153](src/dex/adapters/MapleAdapter.sol#L153)

	```solidity
	    function claimRedemption(
	```

- Found in src/dex/adapters/OndoAdapter.sol [Line: 75](src/dex/adapters/OndoAdapter.sol#L75)

	```solidity
	    function initiateRedemption(
	```

- Found in src/intent/IntentLending.sol [Line: 76](src/intent/IntentLending.sol#L76)

	```solidity
	    function transferOwnership(address newOwner) external onlyOwner {
	```

- Found in src/intent/IntentLending.sol [Line: 81](src/intent/IntentLending.sol#L81)

	```solidity
	    function setPaused(bool _paused) external onlyOwner {
	```

- Found in src/intent/IntentLending.sol [Line: 86](src/intent/IntentLending.sol#L86)

	```solidity
	    function setOracle(
	```

- Found in src/margin/MarginEngine.sol [Line: 111](src/margin/MarginEngine.sol#L111)

	```solidity
	    function transferOwnership(address newOwner) external onlyOwner {
	```

- Found in src/margin/MarginEngine.sol [Line: 175](src/margin/MarginEngine.sol#L175)

	```solidity
	    function setPaused(bool _paused) external onlyOwner {
	```

- Found in src/margin/MarginEngine.sol [Line: 247](src/margin/MarginEngine.sol#L247)

	```solidity
	    function withdrawProtocolReserves(
	```

- Found in src/mocks/ERC20Mock.sol [Line: 12](src/mocks/ERC20Mock.sol#L12)

	```solidity
	    function setBalance(address account, uint256 amount) public virtual {
	```

- Found in src/mocks/OracleMock.sol [Line: 9](src/mocks/OracleMock.sol#L9)

	```solidity
	    function setPrice(uint256 newPrice) external {
	```

</details>



## L-15: Address State Variable Set Without Checks

Check for `address(0)` when assigning values to address state variables.

<details><summary>1 Found Instances</summary>


- Found in src/crosschain/adapters/LayerZeroAdapter.sol [Line: 97](src/crosschain/adapters/LayerZeroAdapter.sol#L97)

	```solidity
	        receiver = _receiver;
	```

</details>



## L-16: State Variable Could Be Immutable

State variables that are only changed in the constructor should be declared immutable to save gas. Add the `immutable` attribute to state variables that are only changed in the constructor

<details><summary>3 Found Instances</summary>


- Found in src/crosschain/PositionManager.sol [Line: 81](src/crosschain/PositionManager.sol#L81)

	```solidity
	    address public owner;
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 24](src/crosschain/RemoteExecutor.sol#L24)

	```solidity
	    address public owner;
	```

- Found in src/crosschain/adapters/LayerZeroAdapter.sol [Line: 47](src/crosschain/adapters/LayerZeroAdapter.sol#L47)

	```solidity
	    address public owner;
	```

</details>



## L-17: Unchecked Return

Function returns a value but it is ignored. Consider checking the return value.

<details><summary>7 Found Instances</summary>


- Found in src/crosschain/RemoteExecutor.sol [Line: 309](src/crosschain/RemoteExecutor.sol#L309)

	```solidity
	        adapter.sendMessage(
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 334](src/crosschain/RemoteExecutor.sol#L334)

	```solidity
	        adapter.sendMessage(
	```

- Found in src/crosschain/RemoteExecutor.sol [Line: 445](src/crosschain/RemoteExecutor.sol#L445)

	```solidity
	        adapter.sendMessage(
	```

- Found in src/dex/Dex.sol [Line: 572](src/dex/Dex.sol#L572)

	```solidity
	            _borrowFromMorpho(tokenOut, fromBorrow);
	```

- Found in src/dex/adapters/CentrifugeAdapter.sol [Line: 101](src/dex/adapters/CentrifugeAdapter.sol#L101)

	```solidity
	        ICentrifugePool(pool).requestRedeem(amount, receiver, address(this));
	```

- Found in src/dex/adapters/MapleAdapter.sol [Line: 118](src/dex/adapters/MapleAdapter.sol#L118)

	```solidity
	        IMaplePool(pool).requestRedeem(amount, address(this));
	```

- Found in src/margin/MarginEngine.sol [Line: 578](src/margin/MarginEngine.sol#L578)

	```solidity
	            morpho.repay(marketParams, assetsToRepay, 0, address(this), "");
	```

</details>



## L-18: Uninitialized Local Variable

Initialize all the variables. If a variable is meant to be initialized to zero, explicitly set it to zero to improve code readability.

<details><summary>1 Found Instances</summary>


- Found in src/Morpho.sol [Line: 817](src/Morpho.sol#L817)

	```solidity
	        for (uint256 i; i < nSlots; ) {
	```

</details>



## L-19: Unsafe ERC20 Operation

ERC20 functions may not behave as expected. For example: return values are not always meaningful. It is recommended to use OpenZeppelin's SafeERC20 library.

<details><summary>3 Found Instances</summary>


- Found in src/libraries/SafeTransferLib.sol [Line: 24](src/libraries/SafeTransferLib.sol#L24)

	```solidity
	            address(token).call(abi.encodeCall(IERC20Internal.transfer, (to, value)));
	```

- Found in src/libraries/SafeTransferLib.sol [Line: 33](src/libraries/SafeTransferLib.sol#L33)

	```solidity
	            address(token).call(abi.encodeCall(IERC20Internal.transferFrom, (from, to, value)));
	```

- Found in src/libraries/SafeTransferLib.sol [Line: 42](src/libraries/SafeTransferLib.sol#L42)

	```solidity
	            address(token).call(abi.encodeCall(IERC20Internal.approve, (spender, value)));
	```

</details>



## L-20: Unspecific Solidity Pragma

Consider using a specific version of Solidity in your contracts instead of a wide version. For example, instead of `pragma solidity ^0.8.0;`, use `pragma solidity 0.8.0;`

<details><summary>12 Found Instances</summary>


- Found in src/dex/interfaces/IDex.sol [Line: 2](src/dex/interfaces/IDex.sol#L2)

	```solidity
	pragma solidity >=0.5.0;
	```

- Found in src/interfaces/IERC20.sol [Line: 2](src/interfaces/IERC20.sol#L2)

	```solidity
	pragma solidity >=0.5.0;
	```

- Found in src/interfaces/IIrm.sol [Line: 2](src/interfaces/IIrm.sol#L2)

	```solidity
	pragma solidity >=0.5.0;
	```

- Found in src/interfaces/IMorpho.sol [Line: 2](src/interfaces/IMorpho.sol#L2)

	```solidity
	pragma solidity >=0.5.0;
	```

- Found in src/interfaces/IMorphoCallbacks.sol [Line: 2](src/interfaces/IMorphoCallbacks.sol#L2)

	```solidity
	pragma solidity >=0.5.0;
	```

- Found in src/interfaces/IOracle.sol [Line: 2](src/interfaces/IOracle.sol#L2)

	```solidity
	pragma solidity >=0.5.0;
	```

- Found in src/libraries/ConstantsLib.sol [Line: 2](src/libraries/ConstantsLib.sol#L2)

	```solidity
	pragma solidity ^0.8.0;
	```

- Found in src/mocks/ERC20Mock.sol [Line: 2](src/mocks/ERC20Mock.sol#L2)

	```solidity
	pragma solidity ^0.8.0;
	```

- Found in src/mocks/FlashBorrowerMock.sol [Line: 2](src/mocks/FlashBorrowerMock.sol#L2)

	```solidity
	pragma solidity ^0.8.0;
	```

- Found in src/mocks/IrmMock.sol [Line: 2](src/mocks/IrmMock.sol#L2)

	```solidity
	pragma solidity ^0.8.0;
	```

- Found in src/mocks/OracleMock.sol [Line: 2](src/mocks/OracleMock.sol#L2)

	```solidity
	pragma solidity ^0.8.0;
	```

- Found in src/mocks/interfaces/IERC20.sol [Line: 2](src/mocks/interfaces/IERC20.sol#L2)

	```solidity
	pragma solidity ^0.8.0;
	```

</details>



## L-21: Unused Error

Consider using or removing the unused error.

<details><summary>7 Found Instances</summary>


- Found in src/crosschain/RemoteExecutor.sol [Line: 80](src/crosschain/RemoteExecutor.sol#L80)

	```solidity
	    error InsufficientShares();
	```

- Found in src/dex/RedemptionFacility.sol [Line: 106](src/dex/RedemptionFacility.sol#L106)

	```solidity
	    error RWAAlreadyEnabled();
	```

- Found in src/dex/adapters/CentrifugeAdapter.sol [Line: 63](src/dex/adapters/CentrifugeAdapter.sol#L63)

	```solidity
	    error RedemptionPending();
	```

- Found in src/interfaces/IIntentLending.sol [Line: 108](src/interfaces/IIntentLending.sol#L108)

	```solidity
	    error InvalidRate();
	```

- Found in src/interfaces/IIntentLending.sol [Line: 118](src/interfaces/IIntentLending.sol#L118)

	```solidity
	    error LoanNotExpired();
	```

- Found in src/interfaces/IMarginEngine.sol [Line: 115](src/interfaces/IMarginEngine.sol#L115)

	```solidity
	    error LoanMarketNotEnabled();
	```

- Found in src/interfaces/IMarginEngine.sol [Line: 123](src/interfaces/IMarginEngine.sol#L123)

	```solidity
	    error StalePrice();
	```

</details>



## L-22: Unused Import

Redundant import statement. Consider removing it.

<details><summary>5 Found Instances</summary>


- Found in src/dex/RedemptionFacility.sol [Line: 8](src/dex/RedemptionFacility.sol#L8)

	```solidity
	import {IOracle} from "../interfaces/IOracle.sol";
	```

- Found in src/dex/adapters/BackedAdapter.sol [Line: 5](src/dex/adapters/BackedAdapter.sol#L5)

	```solidity
	import {IRedemptionAdapter} from "../interfaces/IRedemptionAdapter.sol";
	```

- Found in src/dex/adapters/CentrifugeAdapter.sol [Line: 5](src/dex/adapters/CentrifugeAdapter.sol#L5)

	```solidity
	import {IRedemptionAdapter} from "../interfaces/IRedemptionAdapter.sol";
	```

- Found in src/dex/adapters/MapleAdapter.sol [Line: 5](src/dex/adapters/MapleAdapter.sol#L5)

	```solidity
	import {IRedemptionAdapter} from "../interfaces/IRedemptionAdapter.sol";
	```

- Found in src/dex/adapters/OndoAdapter.sol [Line: 5](src/dex/adapters/OndoAdapter.sol#L5)

	```solidity
	import {IRedemptionAdapter} from "../interfaces/IRedemptionAdapter.sol";
	```

</details>



